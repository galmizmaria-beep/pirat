<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Морской Бой - Редактор</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
        
        :root {
            --sea-water-glow: #2de2e6; --wood-dark: #6a3805; --wood-mid: #a0522d; --wood-light: #d2b48c; --parchment: #f5eeda; --text-dark: #4a2c2a; --danger-red: #e74c3c; --success-green: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background: #333;
        }
        
        #FX_ROOT {
            width: 100%; height: 100%; font-family: 'Pangolin', cursive;
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAoACgDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBQcE/8QAIxAAAgEDAwUBAQAAAAAAAAAAAQIDBAURAAYSIQcTMRQiQf/EABkBAAMBAQEAAAAAAAAAAAAAAAMEBQIGAP/EAB4RAAICAgMAAwAAAAAAAAAAAAECAAMRIQQSEzFB/9oADAMBAAIRAxEAPwDVbbtdPV0sNVNULCsyLIsewkgEZGen7nQe9+HNDWQNLRSCnnydqONyH2Psf3Oie2L+nbqP/AKj/AEay953hS21WiiC1VXtP4434RT6Zuv7j71HPNyG7B4G/k5TcaW42msNNeaV4ZB0bhkfsynow9Gs1K8FZAksTrLE4yrqcqR8g1s+3bpobnRw1sRkCTLuAdSpHqpB6EEEfGsQ3bQPZt3Vjptxpa2TfAoP9qTqyj6PUH3+6U1V2oOQfZP1I7L2kSgY2s32y3SnuNIk9O+VPUdmQ+VPqDWKkkSNGeRgiKMszHAA9yakWDbjtC6WqWqkp2p1k7QxO2SRgHHGOvPOjO8dxbfeKGWgpJjUybkPmEbVGActzxkgce+tVvUeS8fWw4G5U7ju25X+s82dkgpwT5VMhyFHufUn6/YaXW+mrb1MKSkgeolPCogLEfU+g+Tqza7FuW5usjQ07wU+R5lS+EVR3PPUn2AJ1t+27TbrDSIlKqq8gAaeUDc7nuc9gPQDgajq22tqJ2+YF+z1Ea33W1Lb7fDTRMWWJNu5hyx7k/kk6yNdOkUbO7BVAySToXe93UdshYRv51QR8MaHhfufQfOsMvG4blflkSGY0VvY8xRtyzD0LN/gYH11NV2Z+q7hX6kht3c1LudyV1/uBp6Z2S2QNlUHBeQerfQeg/c6Q0lLT0MCwU0SQxL0VFAA/Y0+gjSGJIo1CIihVUDAAHQDWbS17iBVCgAfZ//Z');
            background-repeat: repeat;
            display: flex; justify-content: center; align-items: center;
        }
        
        #sb-editor-container { width: 95%; height: 95%; max-width: 1400px; box-sizing: border-box; overflow: hidden; }
        .sb-editor-wrapper { display: flex; gap: 2vh; width: 100%; height: 100%; background: var(--parchment); border: 1.2vh solid var(--wood-dark); border-radius: 2vh; padding: 2vh; box-shadow: 0 0 2.5vh rgba(0,0,0,0.5), 0 0 2vh var(--sea-water-glow) inset; box-sizing: border-box; }
        .sb-editor-main-panel { flex: 1.8; min-width: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 1.5vh; }
        .sb-editor-preview-panel { flex: 1; min-width: 0; }
        .sb-editor-main-panel::-webkit-scrollbar { width: 1.5vh; }
        .sb-editor-main-panel::-webkit-scrollbar-track { background: var(--wood-light); border-radius: 1vh; }
        .sb-editor-main-panel::-webkit-scrollbar-thumb { background: var(--wood-mid); border-radius: 1vh; border: 3px solid var(--wood-light); }
        .sb-editor-section { margin-bottom: 2.5vh; border-bottom: 3px dashed var(--wood-light); padding-bottom: 2.5vh; }
        .sb-editor-section:last-child { border-bottom: none; }
        h2 { text-align:center; font-size: 3.5vh; color: var(--wood-dark); margin: 0 0 2vh 0; text-shadow: 1px 1px 2px var(--wood-light); }
        h3 { font-size: 2.5vh; margin-top: 0; margin-bottom: 1.5vh; color: var(--text-dark); }
        .sb-editor-form-group { margin-bottom: 1.5vh; }
        .sb-editor-form-group label { display: block; margin-bottom: 0.8vh; font-size: 1.9vh; color: var(--text-dark); }
        .sb-editor-form-group input, .sb-editor-form-group textarea, .sb-editor-form-group select { width: 100%; padding: 1.2vh; font-size: 1.8vh; border-radius: 1vh; border: 2px solid var(--wood-mid); background: #fff; font-family: 'Pangolin', cursive; box-sizing: border-box; }
        .sb-editor-form-group input[type="number"] { width: 10vh; }
        .sb-editor-btn { padding: 1.2vh 2.4vh; font-size: 1.8vh; font-family: 'Pangolin', cursive; background: var(--wood-mid); color: var(--parchment); border: 2px solid var(--wood-dark); border-radius: 1vh; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0.5vh 0 var(--wood-dark); }
        #sb-cells-accordion summary { padding: 1.2vh; font-size: 2vh; cursor: pointer; list-style: '⚓ '; }
        .sb-cell-content { padding: 1.5vh 1.5vh 1.5vh 3vh; background: rgba(210, 180, 140, 0.2); border-radius: 1vh; }
        .sb-character-uploader { display: flex; align-items: center; gap: 1.5vh; }
        .sb-character-preview { width: 8vh; height: 8vh; border: 3px dashed var(--wood-mid); border-radius: 1vh; background-size: cover; background-position: center; }
        .sb-answer-group { display: flex; align-items: center; gap: 1vh; margin-bottom: 1vh; }
    </style>
</head>
<body>
    <div id="FX_ROOT">
        <div id="sb-editor-container">
            <div class="sb-editor-wrapper">
                <div class="sb-editor-main-panel">
                    <h2>Редактор 'Морской Бой'</h2>
                    <div class="sb-editor-section">
                        <h3>1. Общие настройки</h3>
                        <div class="sb-editor-form-group"><label for="sb-player-lives">Жизни игрока:</label><input type="number" id="sb-player-lives" value="3" min="1" max="10"></div>
                    </div>
                    <div class="sb-editor-section">
                        <h3>2. Персонажи</h3>
                        <div id="sb-characters-list-editor"></div>
                        <button id="sb-add-character-btn" class="sb-editor-btn">Добавить персонажа</button>
                    </div>
                    <div class="sb-editor-section">
                        <h3>3. Игровое поле</h3>
                        <div id="sb-cells-accordion"></div>
                    </div>
                    <div class="sb-editor-section">
                        <h3>4. Сгенерировать страницу с игрой</h3>
                        <button id="sb-generate-btn" class="sb-editor-btn">Сгенерировать HTML-код</button>
                        <div id="sb-generated-code-container" style="display: none; margin-top: 2vh;">
                            <label for="sb-generated-code" style="display:block; margin-bottom:1vh;"><b>Готово!</b> Скопируйте весь этот код, создайте на GitHub новый файл (например, `game1.html`) и вставьте код туда. Затем используйте ссылку на этот новый файл в Genially.</label>
                            <textarea id="sb-generated-code" readonly style="width: 100%; height: 15vh; box-sizing: border-box;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function runEditor() {
        const root = document.getElementById('FX_ROOT');
        let characterCount = 0;

        function addCharacterField() {
            if (characterCount >= 5) { alert("Можно добавить не более 5 персонажей."); return; }
            characterCount++;
            const charDiv = document.createElement('div');
            charDiv.className = 'sb-character-uploader';
            charDiv.style.marginBottom = '1.5vh';
            charDiv.innerHTML = `<div id="char-preview-${characterCount}" class="sb-character-preview"></div><label for="char-upload-${characterCount}" class="sb-editor-btn">Загрузить ${characterCount}</label><input type="file" id="char-upload-${characterCount}" data-preview-id="char-preview-${characterCount}" accept="image/*" style="display:none;">`;
            root.querySelector('#sb-characters-list-editor').appendChild(charDiv);
        }

        function initEditor() {
            const cellsAccordion = root.querySelector('#sb-cells-accordion');
            for (let i = 0; i < 9; i++) {
                const details = document.createElement('details');
                details.innerHTML = `<summary>Ячейка ${i + 1}</summary>
                    <div class="sb-cell-content">
                        <div class="sb-editor-form-group"><label>Тип ячейки:</label><select class="sb-cell-type"><option value="normal">Задание</option><option value="chest">Сундук (+1)</option><option value="sword">Меч (-1)</option></select></div>
                        <div class="sb-cell-question-group">
                           <div class="sb-editor-form-group"><label>Вопрос:</label><textarea class="sb-cell-question" rows="2"></textarea></div>
                           <label>Ответы (первый - правильный):</label>
                           <div class="sb-editor-form-group"><input type="text" placeholder="Правильный ответ"></div>
                           <div class="sb-editor-form-group"><input type="text" placeholder="Неправильный ответ 1"></div>
                           <div class="sb-editor-form-group"><input type="text" placeholder="Неправильный ответ 2"></div>
                           <div class="sb-editor-form-group"><input type="text" placeholder="Неправильный ответ 3"></div>
                        </div>
                    </div>`;
                cellsAccordion.appendChild(details);
                const typeSelect = details.querySelector('.sb-cell-type');
                const questionGroup = details.querySelector('.sb-cell-question-group');
                typeSelect.addEventListener('change', () => { questionGroup.style.display = typeSelect.value === 'normal' ? 'block' : 'none'; });
                questionGroup.style.display = 'block'; // По умолчанию показываем
            }
            addCharacterField();
        }

        document.body.addEventListener('change', e => {
            if (e.target.matches('input[type="file"]')) {
                const file = e.target.files[0]; const previewId = e.target.dataset.previewId; const previewDiv = document.getElementById(previewId);
                if (file && previewDiv) {
                    const reader = new FileReader();
                    reader.onload = (event) => { previewDiv.style.backgroundImage = `url(${event.target.result})`; previewDiv.dataset.base64 = event.target.result; };
                    reader.readAsDataURL(file);
                }
            }
        });

        root.querySelector('#sb-add-character-btn').addEventListener('click', addCharacterField);
        
        root.querySelector('#sb-generate-btn').addEventListener('click', () => {
            try {
                const config = { lives: parseInt(root.querySelector('#sb-player-lives').value), characters: [], cells: [] };
                root.querySelectorAll('.sb-character-preview').forEach(preview => { if (preview.dataset.base64) { config.characters.push(preview.dataset.base64); } });
                if (config.characters.length === 0) { alert("Загрузите хотя бы одного персонажа."); return; }
                
                Array.from(root.querySelectorAll('#sb-cells-accordion details')).forEach((details, index) => {
                    const type = details.querySelector('.sb-cell-type').value;
                    let cellData = { type };
                    if (type === 'normal') {
                        const question = details.querySelector('.sb-cell-question').value.trim();
                        const answers = Array.from(details.querySelectorAll('.sb-cell-question-group input[type="text"]')).map(input => input.value.trim()).filter(Boolean);
                        if (!question || answers.length < 2) {
                            alert(`Ошибка в ячейке ${index + 1}: для задания нужен вопрос и как минимум 2 ответа (правильный и один неправильный).`);
                            throw new Error("Validation failed");
                        }
                        cellData.question = question;
                        cellData.answers = answers; // Первый ответ - правильный
                    }
                    config.cells.push(cellData);
                });
                
                const generatedHTML = createGamePageTemplate(config);
                const generatedCodeArea = root.querySelector('#sb-generated-code');
                generatedCodeArea.value = generatedHTML;
                root.querySelector('#sb-generated-code-container').style.display = 'block';
                generatedCodeArea.select();
            } catch (error) {
                console.error(error.message); // Просто выводим ошибку в консоль, чтобы не прерывать работу редактора
            }
        });
        
        initEditor();
    }

    function createGamePageTemplate(config) {
        const configString = JSON.stringify(config);
        return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Морской Бой</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
        :root { --sea-water-glow: #2de2e6; --wood-dark: #6a3805; --wood-mid: #a0522d; --wood-light: #d2b48c; --parchment: #f5eeda; --text-dark: #4a2c2a; --danger-red: #e74c3c; --success-green: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5); }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #333; }
        #FX_ROOT { width: 100%; height: 100%; font-family: 'Pangolin', cursive; display: flex; justify-content: center; align-items: center; background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAoACgDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBQcE/8QAIxAAAgEDAwUBAQAAAAAAAAAAAQIDBAURAAYSIQcTMRQiQf/EABkBAAMBAQEAAAAAAAAAAAAAAAMEBQIGAP/EAB4RAAICAgMAAwAAAAAAAAAAAAECAAMRIQQSEzFB/9oADAMBAAIRAxEAPwDVbbtdPV0sNVNULCsyLIsewkgEZGen7nQe9+HNDWQNLRSCnnydqONyH2Psf3Oie2L+nbqP/AKj/AEay953hS21WiiC1VXtP4434RT6Zuv7j71HPNyG7B4G/k5TcaW42msNNeaV4ZB0bhkfsynow9Gs1K8FZAksTrLE4yrqcqR8g1s+3bpobnRw1sRkCTLuAdSpHqpB6EEEfGsQ3bQPZt3Vjptxpa2TfAoP9qTqyj6PUH3+6U1V2oOQfZP1I7L2kSgY2s32y3SnuNIk9O+VPUdmQ+VPqDWKkkSNGeRgiKMszHAA9yakWDbjtC6WqWqkp2p1k7QxO2SRgHHGOvPOjO8dxbfeKGWgpJjUybkPmEbVGActzxkgce+tVvUeS8fWw4G5U7ju25X+s82dkgpwT5VMhyFHufUn6/YaXW+mrb1MKSkgeolPCogLEfU+g+Tqza7FuW5usjQ07wU+R5lS+EVR3PPUn2AJ1t+27TbrDSIlKqq8gAaeUDc7nuc9gPQDgajq22tqJ2+YF+z1Ea33W1Lb7fDTRMWWJNu5hyx7k/kk6yNdOkUbO7BVAySToXe93UdshYRv51QR8MaHhfufQfOsMvG4blflkSGY0VvY8xRtyzD0LN/gYH11NV2Z+q7hX6kht3c1LudyV1/uBp6Z2S2QNlUHBeQerfQeg/c6Q0lLT0MCwU0SQxL0VFAA/Y0+gjSGJIo1CIihVUDAAHQDWbS17iBVCgAfZ//Z'); }
        #sb-game-container { display: block; width: 100%; height: 100%; color: var(--text-dark); box-sizing: border-box; padding: 2vh; }
        .sb-game-wrapper { display: flex; flex-direction: column; height: 100%; background: var(--parchment); border: 1.2vh solid var(--wood-dark); border-radius: 2vh; padding: 2vh; box-shadow: 0 0 2.5vh rgba(0,0,0,0.5), 0 0 2vh var(--sea-water-glow) inset; box-sizing: border-box; }
        .sb-game-header { display: flex; justify-content: space-between; align-items: center; padding: 0 1vh 2vh 1vh; }
        .sb-game-character { display: flex; align-items: center; gap: 1.5vh; }
        .sb-game-character img { width: 8vh; height: 8vh; border-radius: 50%; border: 4px solid var(--wood-mid); }
        .sb-game-lives { font-size: 3vh; } .sb-game-lives .heart { color: var(--danger-red); font-size: 4vh; }
        .sb-game-board { flex-grow: 1; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 1.5vh; }
        .sb-game-cell { background: var(--wood-light); border: 4px solid var(--wood-mid); border-radius: 1.5vh; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 50 C25 25, 75 25, 75 50 S125 75, 75 100 S25 75, 25 50' fill='none' stroke='%23a0522d' stroke-width='3'/%3E%3C/svg%3E"); background-size: 50%; background-repeat: no-repeat; background-position: center; }
        .sb-game-cell.opened { background-color: var(--parchment); cursor: default; }
        .sb-game-cell.success { background-color: #d4edda; border-color: var(--success-green); } .sb-game-cell.fail { background-color: #f8d7da; border-color: var(--danger-red); }
        .sb-game-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .sb-game-modal-content { background: var(--parchment); padding: 3vh; border-radius: 2vh; border: 1vh solid var(--wood-dark); text-align: center; max-width: 90%; width: 500px; }
        .sb-game-modal-content h4 { font-size: 3vh; margin: 0 0 2vh 0; } .sb-game-modal-answers { display: grid; gap: 1.5vh; margin-top: 2vh; }
        .sb-game-answer-btn { padding: 1.5vh; font-size: 2vh; background: var(--wood-light); border: 3px solid var(--wood-mid); border-radius: 1vh; cursor: pointer; }
        .sb-game-final-btn { margin-top: 3vh; padding: 1.5vh 3vh; font-size: 2.2vh; background: var(--wood-mid); color: var(--parchment); border: 2px solid var(--wood-dark); border-radius: 1vh; cursor: pointer; }
    </style>
</head>
<body><div id="FX_ROOT"><div id="sb-game-container"></div></div>
<script>
    const config = ${configString};
    document.addEventListener('DOMContentLoaded', () => {
        const gameContainer = document.getElementById('sb-game-container');
        let currentLives = config.lives;
        const playerCharacter = config.characters[Math.floor(Math.random() * config.characters.length)];
        gameContainer.innerHTML = \`<div class="sb-game-wrapper"><div class="sb-game-header"><div class="sb-game-character"><img src="\${playerCharacter}"><span>Ваш Пират</span></div><div class="sb-game-lives"></div></div><div class="sb-game-board"></div></div>\`;
        const board = gameContainer.querySelector('.sb-game-board');
        const livesDisplay = gameContainer.querySelector('.sb-game-lives');
        function updateLives() { livesDisplay.innerHTML = \`Жизни: \${Array(currentLives).fill('<span class="heart">♥</span>').join('')}\`; }
        function showModal(content) { const modal = document.createElement('div'); modal.className = 'sb-game-modal-overlay'; modal.innerHTML = \`<div class="sb-game-modal-content">\${content}</div>\`; document.body.appendChild(modal); return modal; }
        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        config.cells.forEach(cellData => {
            const cell = document.createElement('div');
            cell.className = 'sb-game-cell';
            board.appendChild(cell);
            cell.addEventListener('click', () => {
                if (cell.classList.contains('opened') || currentLives <= 0) return;
                cell.classList.add('opened');
                if (cellData.type === 'normal') {
                    const correct = cellData.answers[0];
                    const shuffledAnswers = shuffle([...cellData.answers]);
                    let answersHTML = shuffledAnswers.map(answer => \`<button class="sb-game-answer-btn">\${answer}</button>\`).join('');
                    const questionModal = showModal(\`<h4>\${cellData.question}</h4><div class="sb-game-modal-answers">\${answersHTML}</div>\`);
                    questionModal.querySelector('.sb-game-modal-answers').addEventListener('click', e => {
                        if (e.target.tagName === 'BUTTON') {
                            if (e.target.textContent === correct) { cell.classList.add('success'); } else { currentLives--; cell.classList.add('fail'); }
                            questionModal.remove(); updateLives();
                        }
                    });
                } else {
                    if (cellData.type === 'chest') { currentLives++; cell.classList.add('success'); } else { currentLives--; cell.classList.add('fail'); }
                    updateLives();
                }
            });
        });
        updateLives();
    });
<\/script>
</body></html>`;
    }

    // Запуск редактора при загрузке страницы
    document.addEventListener('DOMContentLoaded', runEditor);
    </script>
</body>
</html>
