<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Морской Бой - Golden Quest Style</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'IM Fell English SC', serif;
            background-color: #f4e9d8;
            background-image: url('https://www.transparenttextures.com/patterns/crissxcross.png');
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url(https://raw.githubusercontent.com/galmizmaria-beep/pirat/main/%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D1%8B%D0%B8%CC%86%20%D1%84%D0%BE%D0%BD.png) no-repeat center center;
            background-size: cover; display: flex; justify-content: center; align-items: center;
            flex-direction: column; z-index: 100;
        }

        #start-button {
            position: absolute; bottom: 120px; padding: 10px 40px; font-size: 4em;
            color: #5d2b1c; text-shadow: 2px 2px 0px #d4a775; background-color: #d4a775;
            border: 5px solid #6b4f35; border-radius: 15px; cursor: pointer;
            animation: pulse 2s infinite; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        #loading-bar-container {
            position: absolute; bottom: 60px; width: 400px; height: 20px;
            background-color: rgba(0,0,0,0.3); border: 2px solid #6b4f35; border-radius: 10px; overflow: hidden;
        }

        #loading-bar-progress { width: 0%; height: 100%; background-color: #d4a775; border-radius: 8px; animation: load 2.5s ease-out forwards; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes load { from { width: 0%; } to { width: 100%; } }

        #game-container {
            position: relative; width: 800px; height: 600px; background-color: transparent;
            border: 15px solid #6b4f35; border-image: url(https://i.postimg.cc/yN1T9T6T/wood-frame.png) 30 stretch;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); color: #4a3728;
        }

        .game-element { position: absolute; }
        
        #game_board { top: 150px; left: 275px; display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px; }
        .cell { width: 80px; height: 80px; background-color: #a2d2ff; border: 2px solid #5c85a6; border-radius: 5px; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .cell:hover { transform: scale(1.05); }

        .crater { width: 80px; height: 80px; background-color: #3d5a80; border-radius: 50%; border: 3px dashed #98c1d9; visibility: hidden; }
        .explosion { width: 100px; height: 100px; background: url(https://i.postimg.cc/W3tY4X2s/explosion.gif) no-repeat center center; background-size: contain; transform: translate(-10px, -10px); visibility: hidden; }
        .content-icon { width: 60px; height: 60px; margin: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; visibility: hidden; }

        /* ИЗМЕНЕНИЕ: Исправлена ссылка на персонажа */
        #ship {
            width: 150px;
            height: 200px;
            /* ПРАВИЛЬНАЯ ПРЯМАЯ ССЫЛКА НА КАРТИНКУ */
            background: url(https://raw.githubusercontent.com/galmizmaria-beep/pirat/main/%D0%94%D0%B8%D0%B7%D0%B0%D0%B8%CC%86%D0%BD%20%D0%B1%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(1).png) no-repeat center bottom;
            background-size: contain;
            top: 390px; left: 40px; cursor: pointer; transition: transform 0.2s;
        }
        #ship:hover { transform: scale(1.05); }

        #cannonball { width: 30px; height: 30px; background-color: #333; border-radius: 50%; top: 480px; left: 140px; visibility: hidden; }
        
        #hud { top: 20px; left: 20px; display: flex; align-items: center; }
        .life_icon { width: 40px; height: 40px; background: url(https://i.postimg.cc/D0A8GfV4/heart-icon.png) no-repeat center center; background-size: contain; display: inline-block; margin-right: 5px; }
        
        /* ИЗМЕНЕНИЕ: Стили для счетчика снарядов */
        #shots_counter_container {
            margin-left: 20px;
            font-size: 1.8em;
            color: #4a3728;
            text-shadow: 1px 1px 0px #c8b6a6;
        }

        #timer_display { top: 15px; right: 30px; font-size: 3.5em; font-weight: bold; color: #c92a2a; text-shadow: 2px 2px 2px #6b4f35; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; visibility: hidden; }
        .modal-content { background-color: #f4e9d8; padding: 40px; border-radius: 5px; border: 10px solid transparent; border-image: url(https://i.postimg.cc/yN1T9T6T/wood-frame.png) 20 stretch; width: 80%; max-width: 500px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #question_text { font-size: 2em; margin-bottom: 20px; color: #4a3728; }
        .answer-button { padding: 12px 20px; margin-bottom: 10px; background-color: #8c6d52; color: #f4e9d8; border: 2px solid #6b4f35; border-radius: 5px; text-align: center; cursor: pointer; font-weight: bold; font-size: 1.2em; font-family: 'IM Fell English SC', serif; text-shadow: 1px 1px 1px #4a3728; box-shadow: 0 4px 0 #6b4f35; transition: all 0.1s ease-in-out; }
        .answer-button:hover { background-color: #a48465; }
        .answer-button:active { transform: translateY(4px); box-shadow: 0 0 0 #6b4f35; }
        .answers-container { display: flex; flex-direction: column; justify-content: center; }
        .final-screen h1 { font-size: 4em; color: #4a3728; text-shadow: 3px 3px 0px #c8b6a6; }
        .final-screen p { font-size: 1.5em; color: #6b4f35; }
        #restart_button { padding: 15px 30px; font-size: 1.2em; background-color: #a01c1c; border-radius: 5px; cursor: pointer; border: 2px solid #6b4f35; margin-top: 20px; color: #f4e9d8; font-family: 'IM Fell English SC', serif; box-shadow: 0 4px 0 #6d1414; transition: all 0.1s ease-in-out; }
        #restart_button:active { transform: translateY(4px); box-shadow: 0 0 0 #6d1414; }
    </style>
</head>
<body>
    <div id="start-screen">
        <div id="loading-bar-container"> <div id="loading-bar-progress"></div> </div>
        <button id="start-button">Играть</button>
    </div>

    <div id="main-game-content" style="display: none;">
        <div id="game-container">
            <div id="game_board" class="game-element">
                <div id="cell1" class="cell"></div> <div id="cell2" class="cell"></div> <div id="cell3" class="cell"></div>
                <div id="cell4" class="cell"></div> <div id="cell5" class="cell"></div> <div id="cell6" class="cell"></div>
                <div id="cell7" class="cell"></div> <div id="cell8" class="cell"></div> <div id="cell9" class="cell"></div>
            </div>
            <div id="effects-layer" style="position: absolute; top: 150px; left: 275px; pointer-events: none;">
                <div id="crater1" class="crater" style="position: absolute; top: 0px; left: 0px;"></div> <div id="crater2" class="crater" style="position: absolute; top: 0px; left: 90px;"></div> <div id="crater3" class="crater" style="position: absolute; top: 0px; left: 180px;"></div>
                <div id="crater4" class="crater" style="position: absolute; top: 90px; left: 0px;"></div> <div id="crater5" class="crater" style="position: absolute; top: 90px; left: 90px;"></div> <div id="crater6" class="crater" style="position: absolute; top: 90px; left: 180px;"></div>
                <div id="crater7" class="crater" style="position: absolute; top: 180px; left: 0px;"></div> <div id="crater8" class="crater" style="position: absolute; top: 180px; left: 90px;"></div> <div id="crater9" class="crater" style="position: absolute; top: 180px; left: 180px;"></div>
                <div id="explosion1" class="explosion" style="position: absolute; top: 0px; left: 0px;"></div> <div id="explosion2" class="explosion" style="position: absolute; top: 0px; left: 90px;"></div> <div id="explosion3" class="explosion" style="position: absolute; top: 0px; left: 180px;"></div>
                <div id="explosion4" class="explosion" style="position: absolute; top: 90px; left: 0px;"></div> <div id="explosion5" class="explosion" style="position: absolute; top: 90px; left: 90px;"></div> <div id="explosion6" class="explosion" style="position: absolute; top: 90px; left: 180px;"></div>
                <div id="explosion7" class="explosion" style="position: absolute; top: 180px; left: 0px;"></div> <div id="explosion8" class="explosion" style="position: absolute; top: 180px; left: 90px;"></div> <div id="explosion9" class="explosion" style="position: absolute; top: 180px; left: 180px;"></div>
                <div id="content1" class="content-icon" style="background-image: url(https://i.postimg.cc/8cRk8Y4Z/chest.png); position: absolute; top: 0px; left: 0px;"></div>
                <div id="content2" class="content-icon" style="background-image: url(https://i.postimg.cc/bN9f57hT/mine.png); position: absolute; top: 0px; left: 90px;"></div>
            </div>
            <div id="hud" class="game-element">
                <div id="life_icon_1" class="life_icon"></div><div id="life_icon_2" class="life_icon"></div><div id="life_icon_3" class="life_icon"></div>
                <!-- ИЗМЕНЕНИЕ: Добавлен контейнер для счетчика -->
                <div id="shots_counter_container">Ядра: <span id="shots_counter_value"></span></div>
            </div>
            <div id="timer_display" class="game-element"></div> <div id="ship" class="game-element"></div> <div id="cannonball" class="game-element"></div>
            <div id="question_window" class="modal-overlay"> <div class="modal-content"><div id="question_text"></div><div class="answers-container"></div></div> </div>
            <div id="chest_window" class="modal-overlay"> <div class="modal-content"><h2>Сокровище!</h2><p>+10 секунд ко времени на ответ!</p></div> </div>
            <div id="mine_window" class="modal-overlay"> <div class="modal-content"><h2>Опасность!</h2><p>Вы потеряли одну жизнь!</p></div> </div>
            <div id="win_screen" class="modal-overlay final-screen"> <div class="modal-content"><h1>ПОБЕДА!</h1><p>Вы великолепный капитан!</p></div> </div>
            <div id="lose_screen" class="modal-overlay final-screen"> <div class="modal-content"><h1>ПОРАЖЕНИЕ</h1><p>Ваш корабль потоплен...</p><div id="restart_button">Попробовать снова</div></div> </div>
        </div>
        <div style="display: none;">
            <div id="config_lives">3</div> <div id="config_time">20</div> <div id="config_bonus">10</div>
            <div id="type_cell1" data-type="chest"></div> <div id="type_cell2" data-type="mine"></div>
            <div id="q_cell3"> <div class="question_text">Столица Франции?</div><div class="correct_answer">Париж</div><div class="wrong_answer">Берлин</div><div class="wrong_answer">Лондон</div> </div>
            <div id="q_cell4"> <div class="question_text">Сколько будет 2 + 2 * 2?</div><div class="correct_answer">6</div><div class="wrong_answer">8</div> </div>
        </div>
    </div>
    
    <audio id="click_sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_51343501c5.mp3" preload="auto"></audio>
    <audio id="whistle_sound" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_e5e3138b37.mp3" preload="auto"></audio>
    <audio id="explosion_sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b2513f124c.mp3" preload="auto"></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ЛОГИКА СТАРТОВОГО ЭКРАНА ---
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const mainGameContent = document.getElementById('main-game-content');

            startButton.addEventListener('click', () => {
                startScreen.style.display = 'none';
                mainGameContent.style.display = 'block';
                initGame(); // Запускаем инициализацию игры
            });

            // --- ОСНОВНАЯ ЛОГИКА ИГРЫ ---
            const gameConfig = {
                initialLives: parseInt(document.getElementById('config_lives').innerText) || 3,
                questionTime: parseInt(document.getElementById('config_time').innerText) || 20,
                bonusTime: parseInt(document.getElementById('config_bonus').innerText) || 10,
            };

            // ИЗМЕНЕНИЕ: Добавлено состояние shotsLeft
            const gameState = {
                currentLives: gameConfig.initialLives,
                currentTimePerQuestion: gameConfig.questionTime,
                availableCellIds: [],
                isActionInProgress: false,
                timerInterval: null,
                shotsLeft: 0, 
            };
            
            // ИЗМЕНЕНИЕ: Добавлены аудио и счетчик снарядов
            const elements = {
                ship: document.getElementById('ship'),
                cannonball: document.getElementById('cannonball'),
                lifeIcons: [document.getElementById('life_icon_1'), document.getElementById('life_icon_2'), document.getElementById('life_icon_3')],
                shotsCounterValue: document.getElementById('shots_counter_value'), // Элемент для цифры счетчика
                timerDisplay: document.getElementById('timer_display'),
                questionWindow: document.getElementById('question_window'),
                chestWindow: document.getElementById('chest_window'),
                mineWindow: document.getElementById('mine_window'),
                winScreen: document.getElementById('win_screen'),
                loseScreen: document.getElementById('lose_screen'),
                restartButton: document.getElementById('restart_button'),
                gameBoard: document.getElementById('game_board'),
                cells: {},
                clickSound: document.getElementById('click_sound'),
                whistleSound: document.getElementById('whistle_sound'),
                explosionSound: document.getElementById('explosion_sound')
            };

            function playSound(sound) {
                if (sound) {
                    sound.currentTime = 0;
                    sound.play();
                }
            }

            function initGame() {
                console.log("Sea Battle Game Initializing...");

                // ИЗМЕНЕНИЕ: Динамический поиск клеток
                const cellElements = document.querySelectorAll('.cell');
                cellElements.forEach(cellEl => {
                    const cellId = cellEl.id;
                    elements.cells[cellId] = {
                        element: cellEl,
                        crater: document.getElementById(`crater${cellId.replace('cell', '')}`),
                        explosion: document.getElementById(`explosion${cellId.replace('cell', '')}`),
                        content: document.getElementById(`content${cellId.replace('cell', '')}`),
                        typeElement: document.getElementById(`type_${cellId}`)
                    };
                    gameState.availableCellIds.push(cellId);
                });
                
                // ИЗМЕНЕНИЕ: Устанавливаем количество выстрелов равным количеству клеток
                gameState.shotsLeft = cellElements.length;

                elements.ship.addEventListener("click", fireCannon);
                elements.restartButton.addEventListener("click", () => window.location.reload());
                
                updateLivesDisplay();
                updateShotsDisplay(); // Обновляем отображение снарядов
                console.log("Game Ready!");
            }

            function fireCannon() {
                // ИЗМЕНЕНИЕ: Добавлена проверка на количество выстрелов
                if (gameState.isActionInProgress || gameState.availableCellIds.length === 0 || gameState.shotsLeft <= 0) {
                    return;
                }
                
                gameState.isActionInProgress = true;
                playSound(elements.clickSound);
                
                // ИЗМЕНЕНИЕ: Уменьшаем количество снарядов и обновляем счетчик
                gameState.shotsLeft--;
                updateShotsDisplay();

                playSound(elements.whistleSound);
                
                const randomIndex = Math.floor(Math.random() * gameState.availableCellIds.length);
                const targetCellId = gameState.availableCellIds[randomIndex];
                const targetCell = elements.cells[targetCellId];
                
                show(elements.cannonball);
                elements.cannonball.style.transition = "all 1s cubic-bezier(0.4, 0, 1, 1)";
                const targetX = targetCell.element.offsetLeft + elements.gameBoard.offsetLeft;
                const targetY = targetCell.element.offsetTop + elements.gameBoard.offsetTop;
                elements.cannonball.style.left = `${targetX + 25}px`;
                elements.cannonball.style.top = `${targetY + 25}px`;

                setTimeout(() => {
                    hide(elements.cannonball);
                    elements.cannonball.style.transition = "none";
                    elements.cannonball.style.left = "140px";
                    elements.cannonball.style.top = "480px";
                    handleHit(targetCellId);
                }, 1000);
            }

            function handleHit(cellId) {
                playSound(elements.explosionSound);
                const cell = elements.cells[cellId];
                if (cell.explosion) show(cell.explosion);

                setTimeout(() => {
                    if (cell.explosion) hide(cell.explosion);
                    if (cell.element) hide(cell.element);
                    if (cell.crater) show(cell.crater);

                    gameState.availableCellIds = gameState.availableCellIds.filter(id => id !== cellId);
                    
                    if (cell.typeElement) {
                        const specialType = cell.typeElement.dataset.type;
                        if (specialType === 'chest') triggerChestBonus(cell);
                        else if (specialType === 'mine') triggerMinePenalty(cell);
                    } else {
                        showQuestion(cellId);
                    }
                }, 500);
            }
            
            // ИЗМЕНЕНИЕ: Новая функция для обновления счетчика снарядов
            function updateShotsDisplay() {
                if (elements.shotsCounterValue) {
                    elements.shotsCounterValue.innerText = gameState.shotsLeft;
                }
            }
            
            function updateLivesDisplay() {
                elements.lifeIcons.forEach((icon, index) => {
                    if (index < gameState.currentLives) show(icon);
                    else hide(icon);
                });
            }

            function endTurn() {
                if (gameState.currentLives <= 0) {
                    gameOver(false);
                    return;
                }
                if (gameState.availableCellIds.length === 0) {
                    gameOver(true);
                    return;
                }
                // ИЗМЕНЕНИЕ: Новое условие поражения - закончились снаряды
                if (gameState.shotsLeft <= 0 && gameState.availableCellIds.length > 0) {
                    gameOver(false);
                    return;
                }
                gameState.isActionInProgress = false;
            }

            // --- Остальные функции (showQuestion, gameOver и т.д.) без критических изменений ---
            function showQuestion(cellId){const questionGroup=document.getElementById(`q_${cellId}`);if(!questionGroup){console.warn(`Question for ${cellId} not found. Skipping.`);endTurn();return}const questionText=questionGroup.querySelector(".question_text").innerHTML;const correctAnswer=questionGroup.querySelector(".correct_answer").innerHTML;const wrongAnswers=Array.from(questionGroup.querySelectorAll(".wrong_answer")).map(el=>el.innerHTML);elements.questionWindow.querySelector("#question_text").innerHTML=questionText;const answersContainer=elements.questionWindow.querySelector(".answers-container");answersContainer.innerHTML="";const allAnswers=[{text:correctAnswer,correct:!0},...wrongAnswers.map(text=>({text,correct:!1}))].sort(()=>.5-Math.random());allAnswers.forEach(answer=>{const button=document.createElement("div");button.className="answer-button";button.innerHTML=answer.text;button.addEventListener("click",answer.correct?handleCorrectAnswer:handleWrongAnswer,{once:!0});answersContainer.appendChild(button)});show(elements.questionWindow);startTimer()}
            function handleCorrectAnswer(){stopTimer();hide(elements.questionWindow);endTurn()}
            function handleWrongAnswer(){stopTimer();hide(elements.questionWindow);loseLife();endTurn()}
            function triggerChestBonus(cell){if(cell.content)show(cell.content);gameState.currentTimePerQuestion+=gameConfig.bonusTime;show(elements.chestWindow);setTimeout(()=>{hide(elements.chestWindow);endTurn()},2e3)}
            function triggerMinePenalty(cell){if(cell.content)show(cell.content);show(elements.mineWindow);setTimeout(()=>{hide(elements.mineWindow);loseLife();endTurn()},2e3)}
            function loseLife(){if(gameState.currentLives>0){gameState.currentLives--;updateLivesDisplay()}}
            function gameOver(isWin){gameState.isActionInProgress=!0;hide(elements.ship,elements.gameBoard,...elements.lifeIcons,elements.timerDisplay, document.getElementById('shots_counter_container'));if(isWin)show(elements.winScreen);else show(elements.loseScreen)}
            function startTimer(){let timeLeft=gameState.currentTimePerQuestion;show(elements.timerDisplay);elements.timerDisplay.innerText=timeLeft;gameState.timerInterval=setInterval(()=>{timeLeft--;elements.timerDisplay.innerText=timeLeft;if(timeLeft<=0){handleWrongAnswer()}},1e3)}
            function stopTimer(){clearInterval(gameState.timerInterval);hide(elements.timerDisplay)}
            function show(...els){els.forEach(el=>el&&(el.style.visibility="visible"))}
            function hide(...els){els.forEach(el=>el&&(el.style.visibility="hidden"))}
        });
    </script>
</body>
</html>
