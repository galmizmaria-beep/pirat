<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Морской Бой - Редактор и Игра</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
        
        :root {
            --sea-water-glow: #2de2e6; --wood-dark: #6a3805; --wood-mid: #a0522d; --wood-light: #d2b48c; --parchment: #f5eeda; --text-dark: #4a2c2a; --danger-red: #e74c3c; --success-green: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background: #333;
        }
        
        #FX_ROOT {
            width: 100%; height: 100%; font-family: 'Pangolin', cursive;
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAoACgDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBQcE/8QAIxAAAgEDAwUBAQAAAAAAAAAAAQIDBAURAAYSIQcTMRQiQf/EABkBAAMBAQEAAAAAAAAAAAAAAAMEBQIGAP/EAB4RAAICAgMAAwAAAAAAAAAAAAECAAMRIQQSEzFB/9oADAMBAAIRAxEAPwDVbbtdPV0sNVNULCsyLIsewkgEZGen7nQe9+HNDWQNLRSCnnydqONyH2Psf3Oie2L+nbqP/AKj/AEay953hS21WiiC1VXtP4434RT6Zuv7j71HPNyG7B4G/k5TcaW42msNNeaV4ZB0bhkfsynow9Gs1K8FZAksTrLE4yrqcqR8g1s+3bpobnRw1sRkCTLuAdSpHqpB6EEEfGsQ3bQPZt3Vjptxpa2TfAoP9qTqyj6PUH3+6U1V2oOQfZP1I7L2kSgY2s32y3SnuNIk9O+VPUdmQ+VPqDWKkkSNGeRgiKMszHAA9yakWDbjtC6WqWqkp2p1k7QxO2SRgHHGOvPOjO8dxbfeKGWgpJjUybkPmEbVGActzxkgce+tVvUeS8fWw4G5U7ju25X+s82dkgpwT5VMhyFHufUn6/YaXW+mrb1MKSkgeolPCogLEfU+g+Tqza7FuW5usjQ07wU+R5lS+EVR3PPUn2AJ1t+27TbrDSIlKqq8gAaeUDc7nuc9gPQDgajq22tqJ2+YF+z1Ea33W1Lb7fDTRMWWJNu5hyx7k/kk6yNdOkUbO7BVAySToXe93UdshYRv51QR8MaHhfufQfOsMvG4blflkSGY0VvY8xRtyzD0LN/gYH11NV2Z+q7hX6kht3c1LudyV1/uBp6Z2S2QNlUHBeQerfQeg/c6Q0lLT0MCwU0SQxL0VFAA/Y0+gjSGJIo1CIihVUDAAHQDWbS17iBVCgAfZ//Z');
            background-repeat: repeat;
            display: flex; justify-content: center; align-items: center;
        }
        
        #sb-editor-container { width: 95%; height: 95%; max-width: 1400px; box-sizing: border-box; overflow: hidden; }
        .sb-editor-wrapper { display: flex; gap: 2vh; width: 100%; height: 100%; background: var(--parchment); border: 1.2vh solid var(--wood-dark); border-radius: 2vh; padding: 2vh; box-shadow: 0 0 2.5vh rgba(0,0,0,0.5), 0 0 2vh var(--sea-water-glow) inset; box-sizing: border-box; }
        .sb-editor-main-panel { flex: 1.8; min-width: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 1.5vh; }
        .sb-editor-main-panel::-webkit-scrollbar { width: 1.5vh; }
        .sb-editor-main-panel::-webkit-scrollbar-track { background: var(--wood-light); border-radius: 1vh; }
        .sb-editor-main-panel::-webkit-scrollbar-thumb { background: var(--wood-mid); border-radius: 1vh; border: 3px solid var(--wood-light); }
        .sb-editor-section { margin-bottom: 2.5vh; border-bottom: 3px dashed var(--wood-light); padding-bottom: 2.5vh; }
        h2 { text-align:center; font-size: 3.5vh; color: var(--wood-dark); margin: 0 0 2vh 0; text-shadow: 1px 1px 2px var(--wood-light); }
        h3 { font-size: 2.5vh; margin-top: 0; margin-bottom: 1.5vh; color: var(--text-dark); }
        .sb-editor-form-group { margin-bottom: 1.5vh; }
        label { display: block; margin-bottom: 0.8vh; font-size: 1.9vh; color: var(--text-dark); }
        input[type="number"], textarea, select { width: 100%; padding: 1.2vh; font-size: 1.8vh; border-radius: 1vh; border: 2px solid var(--wood-mid); background: #fff; font-family: 'Pangolin', cursive; box-sizing: border-box; }
        input[type="number"] { width: 10vh; }
        .sb-editor-btn { padding: 1.2vh 2.4vh; font-size: 1.8vh; font-family: 'Pangolin', cursive; background: var(--wood-mid); color: var(--parchment); border: 2px solid var(--wood-dark); border-radius: 1vh; cursor: pointer; }
        .sb-character-uploader { display: flex; align-items: center; gap: 1.5vh; }
        .sb-character-preview { width: 8vh; height: 8vh; border: 3px dashed var(--wood-mid); border-radius: 1vh; background-size: cover; background-position: center; flex-shrink: 0; }
        .sb-answer-group { display: flex; align-items: center; gap: 1vh; margin-bottom: 1vh; }
        #sb-game-container { display: none; } /* Скрыто по умолчанию */
    </style>
</head>
<body>
    <div id="FX_ROOT">
        <!-- Содержимое будет вставлено JS -->
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const hash = window.location.hash.substring(1);
        if (hash.startsWith('config=')) {
            try {
                const configParam = hash.substring('config='.length);
                const decodedConfig = JSON.parse(decodeURIComponent(atob(configParam)));
                runGame(decodedConfig);
            } catch (e) {
                document.body.innerHTML = '<h1>Ошибка загрузки игры.</h1>';
            }
        } else {
            runEditor();
        }
    });

    // --- ЛОГИКА РЕДАКТОРА ---
    function runEditor() {
        document.getElementById('FX_ROOT').innerHTML = `
        <div id="sb-editor-container">
            <div class="sb-editor-wrapper">
                <div class="sb-editor-main-panel">
                    <h2>Редактор 'Морской Бой'</h2>
                    <div class="sb-editor-section"><h3>1. Общие настройки</h3><div class="sb-editor-form-group"><label for="sb-player-lives">Жизни игрока:</label><input type="number" id="sb-player-lives" value="3" min="1" max="10"></div></div>
                    <div class="sb-editor-section"><h3>2. Персонажи</h3><div id="sb-characters-list-editor"></div><button id="sb-add-character-btn" class="sb-editor-btn">Добавить персонажа</button><p style="font-size: 1.4vh; color: #777;">Картинки анонимно загружаются на хостинг ImgBB для создания короткой ссылки.</p></div>
                    <div class="sb-editor-section"><h3>3. Игровое поле (9 ячеек)</h3><div id="sb-cells-accordion"></div></div>
                    <div class="sb-editor-section"><h3>4. Получить код для вставки</h3><button id="sb-generate-btn" class="sb-editor-btn" style="width:100%; font-size: 2.2vh; padding: 1.5vh;">Сгенерировать код</button><div id="sb-generated-code-container" style="display: none; margin-top: 2vh;"><textarea id="sb-generated-code" readonly style="width: 100%; height: 10vh; resize: none;"></textarea><button id="sb-copy-code-btn" class="sb-editor-btn">Копировать</button></div></div>
                </div>
            </div>
        </div>`;

        let characterCount = 0;
        const addCharacterBtn = document.getElementById('sb-add-character-btn');
        const cellsAccordion = document.getElementById('sb-cells-accordion');
        const generateBtn = document.getElementById('sb-generate-btn');

        function addCharacterField() {
            characterCount++;
            const charDiv = document.createElement('div');
            charDiv.className = 'sb-character-uploader';
            charDiv.innerHTML = `<div id="char-preview-${characterCount}" class="sb-character-preview"></div><label for="char-upload-${characterCount}" class="sb-editor-btn" id="char-label-${characterCount}">Загрузить ${characterCount}</label><input type="file" id="char-upload-${characterCount}" data-label-id="char-label-${characterCount}" data-preview-id="char-preview-${characterCount}" accept="image/*" style="display:none;">`;
            document.getElementById('sb-characters-list-editor').appendChild(charDiv);
        }

        function initEditor() {
            for (let i = 0; i < 9; i++) {
                // Simplified editor fields for brevity
                cellsAccordion.innerHTML += `<details><summary>Ячейка ${i + 1}</summary>... (поля для ячейки) ...</details>`;
            }
            addCharacterField();
        }
        
        document.body.addEventListener('change', async e => {
            if (e.target.matches('input[type="file"]')) {
                const file = e.target.files[0];
                if (!file) return;

                const previewDiv = document.getElementById(e.target.dataset.previewId);
                const label = document.getElementById(e.target.dataset.labelId);
                const originalLabelText = label.textContent;
                label.textContent = 'Загрузка...';

                const formData = new FormData();
                formData.append('image', file);
                
                try {
                    const response = await fetch('https://api.imgbb.com/1/upload?key=c53a7b7e8d550734201735a26a978f14', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        const imageUrl = result.data.url;
                        previewDiv.style.backgroundImage = \`url(\${imageUrl})\`;
                        previewDiv.dataset.imageUrl = imageUrl; // Сохраняем короткую ссылку
                        label.textContent = 'Готово!';
                    } else { throw new Error(result.error.message); }
                } catch (error) {
                    alert('Ошибка загрузки изображения: ' + error.message);
                    label.textContent = originalLabelText;
                }
            }
        });

        addCharacterBtn.addEventListener('click', addCharacterField);

        generateBtn.addEventListener('click', () => {
            try {
                const config = { lives: 3, characters: [], cells: [] }; // simplified
                document.querySelectorAll('.sb-character-preview').forEach(preview => {
                    if (preview.dataset.imageUrl) { // Собираем короткие ссылки
                        config.characters.push(preview.dataset.imageUrl);
                    }
                });

                if (config.characters.length === 0) { throw new Error("Загрузите хотя бы одного персонажа."); }

                // Simplified cell data collection
                config.cells = Array(9).fill({ type: 'normal', question: 'Вопрос?', answers: ['Да', 'Нет'], correctIndex: 0 });

                const base64Config = btoa(encodeURIComponent(JSON.stringify(config)));
                const baseUrl = window.location.href.split('#')[0];
                const gameUrl = baseUrl + '#config=' + base64Config;
                const iframeCode = \`<div style="position: relative; width: 100%; padding-top: 56.25%;"><iframe src="\${gameUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe></div>\`;
                
                document.getElementById('sb-generated-code').value = iframeCode;
                document.getElementById('sb-generated-code-container').style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        });
        
        document.body.addEventListener('click', e => {
            if (e.target.id === 'sb-copy-code-btn') {
                const textarea = document.getElementById('sb-generated-code');
                textarea.select();
                document.execCommand('copy');
                e.target.textContent = 'Скопировано!';
                setTimeout(() => { e.target.textContent = 'Копировать'; }, 2000);
            }
        });

        initEditor();
    }
    
    // --- ЛОГИКА ИГРЫ ---
    function runGame(config) {
        document.getElementById('FX_ROOT').innerHTML = \`
        <style>
            #sb-game-container { display: block; width: 100%; height: 100%; color: var(--text-dark); box-sizing: border-box; padding: 2vh; }
            .sb-game-wrapper { display: flex; flex-direction: column; height: 100%; background: var(--parchment); border: 1.2vh solid var(--wood-dark); border-radius: 2vh; padding: 2vh; box-shadow: 0 0 2.5vh rgba(0,0,0,0.5), 0 0 2vh var(--sea-water-glow) inset; box-sizing: border-box; }
            .sb-game-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 2vh; }
            .sb-game-character img { width: 8vh; height: 8vh; border-radius: 50%; border: 4px solid var(--wood-mid); }
            .sb-game-lives .heart { color: var(--danger-red); font-size: 4vh; }
            .sb-game-board { flex-grow: 1; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 1.5vh; }
            .sb-game-cell { background: var(--wood-light); border: 4px solid var(--wood-mid); border-radius: 1.5vh; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 50 C25 25, 75 25, 75 50 S125 75, 75 100 S25 75, 25 50' fill='none' stroke='%23a0522d' stroke-width='3'/%3E%3C/svg%3E"); background-size: 50%; background-repeat: no-repeat; background-position: center; }
        </style>
        <div id="sb-game-container"></div>\`;
        
        const gameContainer = document.getElementById('sb-game-container');
        let currentLives = config.lives;
        const playerCharacter = config.characters[0]; // Simplified
        gameContainer.innerHTML = \`<div class="sb-game-wrapper"><div class="sb-game-header"><div class="sb-game-character"><img src="\${playerCharacter}"></div><div class="sb-game-lives"></div></div><div class="sb-game-board"></div></div>\`;
        
        // ... Остальная логика игры ...
    }

    </script>
</body>
</html>
