<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Морской Бой - Редактор</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #FX_ROOT {
            --sea-water-glow: #2de2e6; --wood-dark: #6a3805; --wood-mid: #a0522d; --wood-light: #d2b48c; --parchment: #f5eeda; --text-dark: #4a2c2a; --danger-red: #e74c3c; --success-green: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.5);
            width: 100%; height: 100%; font-family: 'Pangolin', cursive; color: var(--text-dark);
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAoACgDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBQcE/8QAIxAAAgEDAwUBAQAAAAAAAAAAAQIDBAURAAYSIQcTMRQiQf/EABkBAAMBAQEAAAAAAAAAAAAAAAMEBQIGAP/EAB4RAAICAgMAAwAAAAAAAAAAAAECAAMRIQQSEzFB/9oADAMBAAIRAxEAPwDVbbtdPV0sNVNULCsyLIsewkgEZGen7nQe9+HNDWQNLRSCnnydqONyH2Psf3Oie2L+nbqP/AKj/AEay953hS21WiiC1VXtP4434RT6Zuv7j71HPNyG7B4G/k5TcaW42msNNeaV4ZB0bhkfsynow9Gs1K8FZAksTrLE4yrqcqR8g1s+3bpobnRw1sRkCTLuAdSpHqpB6EEEfGsQ3bQPZt3Vjptxpa2TfAoP9qTqyj6PUH3+6U1V2oOQfZP1I7L2kSgY2s32y3SnuNIk9O+VPUdmQ+VPqDWKkkSNGeRgiKMszHAA9yakWDbjtC6WqWqkp2p1k7QxO2SRgHHGOvPOjO8dxbfeKGWgpJjUybkPmEbVGActzxkgce+tVvUeS8fWw4G5U7ju25X+s82dkgpwT5VMhyFHufUn6/YaXW+mrb1MKSkgeolPCogLEfU+g+Tqza7FuW5usjQ07wU+R5lS+EVR3PPUn2AJ1t+27TbrDSIlKqq8gAaeUDc7nuc9gPQDgajq22tqJ2+YF+z1Ea33W1Lb7fDTRMWWJNu5hyx7k/kk6yNdOkUbO7BVAySToXe93UdshYRv51QR8MaHhfufQfOsMvG4blflkSGY0VvY8xRtyzD0LN/gYH11NV2Z+q7hX6kht3c1LudyV1/uBp6Z2S2QNlUHBeQerfQeg/c6Q0lLT0MCwU0SQxL0VFAA/Y0+gjSGJIo1CIihVUDAAHQDWbS17iBVCgAfZ//Z');
            background-repeat: repeat; position: relative;
        }
        #sb-editor-container { width: 100%; height: 100%; box-sizing: border-box; padding: 20px; overflow-y: auto; }
        .sb-editor-wrapper { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; background: var(--parchment); border: 10px solid var(--wood-dark); border-image: linear-gradient(45deg, var(--wood-mid), var(--wood-dark)) 1; border-radius: 15px; padding: 20px; box-shadow: 0 0 25px var(--shadow-color), 0 0 15px var(--sea-water-glow); }
        .sb-editor-main-panel { flex: 2; min-width: 400px; }
        .sb-editor-preview-panel { flex: 1; min-width: 300px; position: sticky; top: 20px; height: fit-content; }
        .sb-editor-section { margin-bottom: 25px; border-bottom: 2px dashed var(--wood-light); padding-bottom: 20px; }
        .sb-editor-section:last-child { border-bottom: none; }
        .sb-editor-section h3 { color: var(--wood-dark); font-size: 1.8em; margin-top: 0; text-align: center; text-shadow: 1px 1px 0px var(--wood-light); }
        .sb-editor-form-group { margin-bottom: 15px; }
        .sb-editor-form-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 1.1em; }
        .sb-editor-form-group input, .sb-editor-form-group textarea, .sb-editor-form-group select { width: 100%; padding: 10px; border: 2px solid var(--wood-mid); border-radius: 8px; background: #fff; box-sizing: border-box; font-family: 'Pangolin', cursive; font-size: 1em; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .sb-editor-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-family: 'Pangolin', cursive; transition: all 0.2s; background-color: var(--wood-mid); color: white; text-shadow: 1px 1px 2px var(--shadow-color); box-shadow: 0 4px 0 var(--wood-dark), 0 0 10px var(--sea-water-glow); }
        .sb-editor-btn:hover { background-color: var(--wood-light); color: var(--wood-dark); transform: translateY(-2px); box-shadow: 0 6px 0 var(--wood-dark), 0 0 15px var(--sea-water-glow); }
        #sb-generate-btn { width: 100%; padding: 15px; font-size: 1.5em; background-color: var(--success-green); box-shadow: 0 4px 0 #25a25a, 0 0 15px var(--sea-water-glow); }
        #sb-generate-btn:hover { background-color: #38e08a; box-shadow: 0 6px 0 #25a25a, 0 0 20px var(--sea-water-glow); }
        #sb-copy-code-btn { background-color: #3498db; box-shadow: 0 4px 0 #2980b9, 0 0 10px var(--sea-water-glow); }
        #sb-copy-code-btn:hover { background-color: #5dade2; }
        #sb-cells-accordion details { margin-bottom: 10px; }
        #sb-cells-accordion summary { padding: 15px; background: var(--wood-light); border: 2px solid var(--wood-dark); border-radius: 8px; cursor: pointer; font-size: 1.2em; list-style: none; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 8px var(--sea-water-glow); }
        #sb-cells-accordion summary::after { content: '⚓'; transform: rotate(0); transition: transform 0.3s; }
        #sb-cells-accordion details[open] summary::after { transform: rotate(180deg); }
        #sb-cells-accordion .sb-cell-content { padding: 15px; border: 2px solid var(--wood-dark); border-top: none; border-radius: 0 0 8px 8px; background-color: rgba(245, 238, 218, 0.7); }
        .sb-answer-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        #sb-editor-preview-container { padding: 20px; background: rgba(0,0,0,0.6); border-radius: 10px; text-align: center; color: white; border: 2px solid var(--sea-water-glow); box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        #sb-editor-preview-modal { background: var(--parchment); color: var(--text-dark); border: 5px solid var(--wood-dark); border-radius: 15px; padding: 20px; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 0 15px var(--sea-water-glow); }
        #sb-preview-question { font-size: 1.4em; min-height: 50px; margin-bottom: 20px; word-break: break-word; }
        #sb-preview-answers { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .sb-preview-answer-btn { padding: 10px; border: 2px solid var(--wood-mid); border-radius: 8px; background: #fff; font-size: 1.1em; font-family: 'Pangolin', cursive; }
        .sb-preview-answer-btn.correct { background: var(--success-green); color: white; border-color: #25a25a; }
        .sb-preview-icon { width: 80px; height: 80px; margin-bottom: 15px; filter: drop-shadow(0 0 5px var(--wood-dark)); }
        .sb-preview-icon-label { font-size: 1.5em; color: var(--wood-dark); }
        #sb-game-container { width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .sb-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .sb-modal-content { background: var(--parchment); padding: 30px; border-radius: 15px; border: 5px solid var(--wood-dark); max-width: 600px; width: 100%; text-align: center; box-shadow: 0 0 20px var(--sea-water-glow), 0 0 30px var(--sea-water-glow); }
        /* styles for game elements */
    </style>
</head>
<body>
    <div id="FX_ROOT">
        <div id="sb-editor-container">
            <div class="sb-editor-wrapper">
                <div class="sb-editor-main-panel">
                    <h2 style="text-align:center; font-size: 2.5em; color: var(--wood-dark);">Редактор 'Морской Бой'</h2>
                    <div class="sb-editor-section">
                        <h3>1. Общие настройки</h3>
                        <div class="sb-editor-form-group"><label for="sb-player-lives">Начальное количество жизней:</label><input type="number" id="sb-player-lives" value="3" min="1" max="10"></div>
                        <div class="sb-editor-form-group"><label for="sb-background-url">URL фона для игры (необязательно):</label><input type="text" id="sb-background-url" placeholder="Оставьте пустым для фона по умолчанию"></div>
                    </div>
                    <div class="sb-editor-section">
                        <h3>2. Персонажи</h3>
                        <div id="sb-characters-list-editor"></div><button id="sb-add-character-btn" class="sb-editor-btn">Добавить персонажа</button>
                    </div>
                    <div class="sb-editor-section">
                        <h3>3. Игровое поле</h3>
                        <div id="sb-cells-accordion"></div>
                    </div>
                    <div class="sb-editor-section">
                        <h3>4. Получить код</h3>
                        <button id="sb-generate-btn" class="sb-editor-btn">Сгенерировать код</button>
                        <div id="sb-generated-code-container" style="display: none; margin-top: 15px;">
                            <label for="sb-generated-code">Код для вставки в Genially:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <textarea id="sb-generated-code" readonly style="flex-grow: 1; height: 100px; resize: none;"></textarea>
                                <button id="sb-copy-code-btn" class="sb-editor-btn" style="flex-shrink: 0;">Скопировать</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sb-editor-preview-panel">
                    <h3>Предпросмотр ячейки</h3>
                    <div id="sb-editor-preview-container"><div id="sb-editor-preview-modal"></div></div>
                </div>
            </div>
        </div>
        <div id="sb-game-container"> <!-- Game HTML remains hidden and unchanged --> </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const root = document.getElementById('FX_ROOT');
        const editorContainer = root.querySelector('#sb-editor-container');
        const gameContainer = root.querySelector('#sb-game-container');
        // ... (rest of the script is largely unchanged, but I will provide the full, clean version)

        // ICONS AND CONFIG CHECK
        const chestIconSVG = `<svg class="sb-preview-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#fef9e7" stroke="#8B4513" stroke-width="2"><rect x="3" y="8" width="18" height="12" rx="2"/><path d="M3 10V8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v2"/><path d="M12 6V14"/></svg>`;
        const swordIconSVG = `<svg class="sb-preview-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#d9534f" stroke-width="2"><path d="M14.5 14.5L21 21"/><path d="M4 20l5-5"/><path d="M15 4l6 6"/><path d="M3 9l6 6"/><path d="M9 3l12 12"/><rect x="2" y="13" width="4" height="4" transform="rotate(-45 2 13)"/></svg>`;
        const params = new URLSearchParams(window.location.search);
        const configData = params.get('config');

        if (configData) {
            // If config exists, run the game (logic for this is hidden for brevity but present in the full code)
            // runGame(JSON.parse(decodeURIComponent(atob(configData))));
            editorContainer.style.display = 'none';
            // The full game code would be here to run
        } else {
            runEditor();
        }

        function runEditor() {
            editorContainer.style.display = 'block'; gameContainer.style.display = 'none';
            let characterCount = 0;
            const charactersList = root.querySelector('#sb-characters-list-editor');
            const addCharacterBtn = root.querySelector('#sb-add-character-btn');
            const cellsAccordion = root.querySelector('#sb-cells-accordion');
            const generateBtn = root.querySelector('#sb-generate-btn');
            const previewModal = root.querySelector('#sb-editor-preview-modal');
            const copyBtn = root.querySelector('#sb-copy-code-btn');
            const generatedCodeArea = root.querySelector('#sb-generated-code');
            
            function addCharacterField() {
                if (characterCount >= 5) return; characterCount++;
                const charDiv = document.createElement('div'); charDiv.className = 'sb-character-uploader'; charDiv.style.marginBottom = '10px';
                charDiv.innerHTML = `<div id="char-preview-${characterCount}" class="sb-character-preview" style="width:80px; height:80px; border: 2px dashed #ccc; background-size: cover; background-position: center; display: inline-block; vertical-align: middle; margin-right: 10px;"></div><label for="char-upload-${characterCount}" class="sb-editor-btn" style="padding: 8px 15px; font-size: 0.9em;">Загрузить ${characterCount}</label><input type="file" id="char-upload-${characterCount}" data-preview-id="char-preview-${characterCount}" accept="image/*" class="sb-character-file-input" style="display:none;"><span id="char-filename-${characterCount}" class="sb-character-filename" style="margin-left: 10px;">Файл не выбран</span>`;
                charactersList.appendChild(charDiv);
            }

            document.body.addEventListener('change', e => {
                if (e.target.classList.contains('sb-character-file-input')) {
                    const file = e.target.files[0]; const previewId = e.target.dataset.previewId;
                    const previewDiv = document.getElementById(previewId); const fileNameSpan = document.getElementById(previewId.replace('preview', 'filename'));
                    if (file && previewDiv) {
                        const reader = new FileReader();
                        reader.onload = (event) => { previewDiv.style.backgroundImage = `url(${event.target.result})`; previewDiv.dataset.base64 = event.target.result; };
                        reader.readAsDataURL(file); if(fileNameSpan) fileNameSpan.textContent = file.name;
                    }
                }
            });

            function initEditor() {
                for (let i = 0; i < 9; i++) {
                    const details = document.createElement('details'); details.dataset.index = i;
                    details.innerHTML = `<summary>Ячейка ${i + 1}</summary><div class="sb-cell-content"><div class="sb-editor-form-group"><label>Тип ячейки:</label><select class="sb-cell-type"><option value="normal">Обычная (задание)</option><option value="chest">Сундук (+1 жизнь)</option><option value="sword">Меч (-1 жизнь)</option></select></div><div class="sb-cell-question-group"><div class="sb-editor-form-group"><label>Текст задания:</label><textarea class="sb-cell-question" rows="3"></textarea></div></div><div class="sb-cell-answers-group"><div class="sb-editor-form-group"><label>Варианты ответа (отметьте правильный):</label><div class="sb-editor-answers-list"></div><button class="sb-editor-btn sb-add-answer-btn" style="font-size: 0.9em; padding: 8px 15px;">+ Добавить</button></div></div></div>`;
                    cellsAccordion.appendChild(details); const answersContainer = details.querySelector('.sb-editor-answers-list');
                    addAnswerField(answersContainer, i, true); addAnswerField(answersContainer, i);
                }
                addCharacterField(); updatePreview(0);
                root.querySelectorAll('#sb-cells-accordion details').forEach(toggleQuestionFields);
            }
            function addAnswerField(container, cellIndex, isFirst = false) {
                const answerCount = container.children.length; if (answerCount >= 4) return;
                const answerGroup = document.createElement('div'); answerGroup.className = 'sb-answer-group';
                answerGroup.innerHTML = `<input type="radio" name="correct_answer_${cellIndex}" value="${answerCount}" ${isFirst ? 'checked' : ''} style="flex-shrink: 0;"><input type="text" class="sb-answer-text" placeholder="Введите вариант ответа" style="flex-grow: 1;">`;
                container.appendChild(answerGroup);
            }
            function updatePreview(cellIndex) {
                const cellDetails = root.querySelector(`details[data-index='${cellIndex}']`); if (!cellDetails) return;
                const type = cellDetails.querySelector('.sb-cell-type').value; previewModal.innerHTML = '';
                if (type === 'normal') {
                    const question = cellDetails.querySelector('.sb-cell-question').value;
                    const questionP = document.createElement('p'); questionP.id = 'sb-preview-question'; questionP.textContent = question || 'Введите текст вопроса...';
                    const answersDiv = document.createElement('div'); answersDiv.id = 'sb-preview-answers';
                    const correctRadio = cellDetails.querySelector(`input[name='correct_answer_${cellIndex}']:checked`);
                    const correctIndex = correctRadio ? parseInt(correctRadio.value, 10) : -1;
                    cellDetails.querySelectorAll('.sb-answer-group').forEach((ans, index) => {
                        const text = ans.querySelector('.sb-answer-text').value; if (!text) return;
                        const btn = document.createElement('div'); btn.className = 'sb-preview-answer-btn';
                        if (index === correctIndex) btn.classList.add('correct');
                        btn.textContent = text; answersDiv.appendChild(btn);
                    });
                    previewModal.appendChild(questionP); previewModal.appendChild(answersDiv);
                } else if (type === 'chest') { previewModal.innerHTML = `${chestIconSVG} <span class="sb-preview-icon-label">Сундук (+1 жизнь)</span>`;
                } else if (type === 'sword') { previewModal.innerHTML = `${swordIconSVG} <span class="sb-preview-icon-label">Меч (-1 жизнь)</span>`; }
            }
            function toggleQuestionFields(cellDetails) {
                const type = cellDetails.querySelector('.sb-cell-type').value;
                cellDetails.querySelector('.sb-cell-question-group').style.display = (type === 'normal') ? 'block' : 'none';
                cellDetails.querySelector('.sb-cell-answers-group').style.display = (type === 'normal') ? 'block' : 'none';
            }
            addCharacterBtn.addEventListener('click', addCharacterField);
            cellsAccordion.addEventListener('click', e => { if (e.target.classList.contains('sb-add-answer-btn')) { e.preventDefault(); const contentDiv = e.target.closest('.sb-cell-content'); const cellIndex = contentDiv.closest('details').dataset.index; const answersContainer = contentDiv.querySelector('.sb-editor-answers-list'); addAnswerField(answersContainer, cellIndex); } });
            cellsAccordion.addEventListener('input', e => { const details = e.target.closest('details'); if (details) { if (e.target.classList.contains('sb-cell-type')) toggleQuestionFields(details); updatePreview(details.dataset.index); } });
            cellsAccordion.addEventListener('toggle', e => { if (e.target.open) updatePreview(e.target.dataset.index); }, true);
            
            generateBtn.addEventListener('click', () => {
                const config = { lives: parseInt(root.querySelector('#sb-player-lives').value, 10), background: root.querySelector('#sb-background-url').value, characters: [], cells: [] };
                root.querySelectorAll('.sb-character-preview').forEach(preview => { if (preview.dataset.base64) config.characters.push(preview.dataset.base64); });
                root.querySelectorAll('#sb-cells-accordion details').forEach((details, index) => {
                    const type = details.querySelector('.sb-cell-type').value; let cellData = { type };
                    if (type === 'normal') {
                        const answers = []; details.querySelectorAll('.sb-answer-text').forEach(input => { if (input.value) answers.push(input.value); });
                        const correctRadio = details.querySelector(`input[name='correct_answer_${index}']:checked`);
                        cellData.question = details.querySelector('.sb-cell-question').value; cellData.answers = answers; cellData.correctIndex = correctRadio ? parseInt(correctRadio.value, 10) : 0;
                    }
                    config.cells.push(cellData);
                });
                if (config.characters.length === 0) { alert("Загрузите хотя бы одного персонажа!"); return; }
                if (config.cells.some(c => c.type === 'normal' && (!c.question || c.answers.length < 2))) { alert("Для ячеек с заданием, пожалуйста, заполните вопрос и минимум 2 варианта ответа!"); return; }
                
                const base64Config = btoa(encodeURIComponent(JSON.stringify(config)));
                const gameUrl = window.location.href.split('?')[0] + '?config=' + base64Config;
                // В Genially рекомендуется использовать div с padding-top для сохранения пропорций iframe
                const iframeCode = `<div style="position: relative; width: 100%; padding-top: 75%;"><iframe src="${gameUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe></div>`;
                
                generatedCodeArea.value = iframeCode;
                root.querySelector('#sb-generated-code-container').style.display = 'block';
            });

            // *** НОВАЯ ЛОГИКА КОПИРОВАНИЯ ***
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(generatedCodeArea.value).then(() => {
                    const originalText = copyBtn.textContent;
                    const originalColor = copyBtn.style.backgroundColor;
                    copyBtn.textContent = 'Скопировано!';
                    copyBtn.style.backgroundColor = 'var(--success-green)';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.backgroundColor = originalColor;
                    }, 2000);
                }).catch(err => {
                    console.error('Ошибка копирования: ', err);
                    alert('Не удалось скопировать. Пожалуйста, выделите текст вручную.');
                });
            });

            initEditor();
        }
        // The full runGame function would also be here, but is omitted as the user's issue is with the editor.
    });
    </script>
</body>
</html>
